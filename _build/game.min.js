!function(){function e(e,t=1,n=0,a=.5,i=!1){var o=audioCtx.createBufferSource(),r=audioCtx.createGain(),s=audioCtx.createStereoPanner();return o.buffer=e,o.connect(s),s.connect(r),r.connect(audioMaster),o.playbackRate.value=t,o.loop=i,r.gain.value=a,s.pan.value=n,o.start(),{volume:r,sound:o}}states={},Key={_pressed:{},_released:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,ONE:49,TWO:50,THREE:51,FOUR:52,a:65,c:67,w:87,s:83,d:68,z:90,x:88,f:70,p:80,r:82,isDown(e){return this._pressed[e]},justReleased(e){return this._released[e]},onKeydown(e){this._pressed[e.keyCode]=!0},onKeyup(e){this._released[e.keyCode]=!0,delete this._pressed[e.keyCode]},update(){this._released={}}};class t{constructor(e){if(e%1!=0)throw new Error("Seed value must be an integer.");this.seed=e%2147483647,this.seed>0||(this.seed+=2147483646)}next(){return this.seed=16807*this.seed%2147483647}nextFloat(){return(this.next()-1)/2147483646}nextBoundedInt(e,t){return Math.floor(this.nextFloat()*(t-e)+e)}}timeStamp=(()=>window.performance&&window.performance.now?window.performance.now():(new Date).getTime()),boxBox=((e,t)=>{let n=e.x,a=e.x+e.width,i=e.y,o=e.y+e.height,r=t.x,s=t.x+t.width,d=t.y,c=t.y+t.height;return!(r>a||n>s||d>o||i>c)});var n=function(){var e,t,n,a,i,o=function(e){return Math.sin(6.283184*e)},r=function(e){return.003959503758*Math.pow(2,(e-128)/12)},s=function(e,t,n){var a,i,o,s,c,l,u,h=d[e.i[0]],w=e.i[1],p=e.i[3],x=d[e.i[4]],f=e.i[5],y=e.i[8],g=e.i[9],v=e.i[10]*e.i[10]*4,m=e.i[11]*e.i[11]*4,b=e.i[12]*e.i[12]*4,C=1/b,K=e.i[13],S=n*Math.pow(2,2-e.i[14]),A=new Int32Array(v+m+b),D=0,E=0;for(a=0,i=0;v+m+b>a;a++,i++)0>i||(i-=S,l=r(t+(15&(K=K>>8|(255&K)<<4))+e.i[2]-128),u=r(t+(15&K)+e.i[6]-128)*(1+8e-4*e.i[7])),o=1,v>a?o=a/v:v+m>a||(o-=(a-v-m)*C),s=l,p&&(s*=o*o),c=h(D+=s)*w,s=u,y&&(s*=o*o),c+=x(E+=s)*f,g&&(c+=(2*Math.random()-1)*g),A[a]=80*c*o|0;return A},d=[o,function(e){return.5>e%1?1:-1},function(e){return e%1*2-1},function(e){var t=e%1*4;return 2>t?t-1:3-t}];this.init=function(o){e=o,t=o.endPattern,n=0,a=o.rowLen*o.patternLen*(t+1)*2,i=new Int32Array(a)},this.generate=function(){var r,c,l,u,h,w,p,x,f,y,g,v,m,b,C=new Int32Array(a),K=e.songData[n],S=e.rowLen,A=e.patternLen,D=0,E=0,I=!1,M=[];for(l=0;t>=l;++l)for(p=K.p[l],u=0;A>u;++u){var R=p?K.c[p-1].f[u]:0;R&&(K.i[R-1]=K.c[p-1].f[u+A]||0,16>R&&(M=[]));var L=d[K.i[15]],X=K.i[16]/512,Y=Math.pow(2,K.i[17]-9)/S,W=K.i[18],k=K.i[19],H=43.23529*K.i[20]*3.141592/44100,P=1-K.i[21]/255,T=1e-5*K.i[22],z=K.i[23]/32,B=K.i[24]/512,F=6.283184*Math.pow(2,K.i[25]-9)/S,O=K.i[26]/255,_=K.i[27]*S&-2;for(g=(l*A+u)*S,h=0;4>h;++h)if(w=p?K.c[p-1].n[u+h*A]:0){M[w]||(M[w]=s(K,w,S));var j=M[w];for(c=0,r=2*g;c<j.length;c++,r+=2)C[r]+=j[c]}for(c=0;S>c;c++)(y=C[x=2*(g+c)])||I?(v=H,W&&(v*=L(Y*x)*X+.5),E+=(v=1.5*Math.sin(v))*(m=P*(y-E)-(D+=v*E)),y=3==k?E:1==k?m:D,T&&(y=1>(y*=T)?y>-1?o(.25*y):-1:1,y/=T),I=(y*=z)*y>1e-5,b=y*(1-(f=Math.sin(F*x)*B+.5)),y*=f):b=0,_>x||(b+=C[x-_+1]*O,y+=C[x-_]*O),C[x]=0|b,C[x+1]=0|y,i[x]+=0|b,i[x+1]+=0|y}return++n/e.numChannels},this.createWave=function(){var e=44+2*a-8,t=e-36,n=new Uint8Array(44+2*a);n.set([82,73,70,70,255&e,e>>8&255,e>>16&255,e>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var o=0,r=44;a>o;++o){var s=i[o];s=-32767>s?-32767:s>32767?32767:s,n[r++]=255&s,n[r++]=s>>8&255}return n},this.getBuffer=function(){return i},this.getData=function(e,t){for(var n=2*Math.floor(44100*e),a=new Array(t),o=0;2*t>o;o+=1){var r=n+o;a[o]=e>0&&r<i.length?i[r]/32768:0}return a}},a={songData:[{i:[3,138,116,0,0,138,128,4,0,0,47,48,166,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[1,1,4,2,3],c:[{n:[111],f:[]},{n:[114],f:[]},{n:[113],f:[]},{n:[112,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,113],f:[]}]}],rowLen:5513,patternLen:32,endPattern:4,numChannels:1},i={songData:[{i:[2,138,116,0,2,138,128,4,0,0,1,29,52,124,3,0,139,4,1,3,64,160,3,32,147,4,57,5],p:[1],c:[{n:[147,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,150],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[1],c:[{n:[],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:2};function o(e,t,n,a,i="#F0F"){actx.fillStyle=i,actx.fillRect(e,t,n,a)}function r(e,t,n=4,a=2,i="#FF0"){actx.fillStyle=i,actx.beginPath(),actx.ellipse(e,t,n,a,0,0,2*Math.PI),actx.fill()}function s(e,t){let n=document.createElement("canvas");return n.width=e,n.height=t,{c:n,ctx:n.getContext("2d")}}player={type:"player",x:0,y:0,width:64,height:64,xVel:0,yVel:0,xAcc:0,yAcc:0,drag:10,speed:.05,draw:function(e){actx=gamectx,actx.drawImage(spriteSheet.c,0,0,100,100,this.x-viewX-this.width/2,this.y-viewY-this.height/2,100,100)},update:function(e){Key.isDown(Key.a)?this.x-=this.speed:Key.isDown(Key.d)&&(this.x+=this.speed),Key.isDown(Key.w)?this.y-=this.speed:Key.isDown(Key.s)&&(this.y+=this.speed)}},states={},init=(()=>{audioCtx=new AudioContext,audioMaster=audioCtx.createGain(),audioMaster.connect(audioCtx.destination),fps=60,tick=1/60,dt=0,start=elapsed=now=last=timeStamp(),state="loading",loadingText=["LOADING","READY","press p to continue","click to focus game"],sounds={},soundsReady=0,totalSounds=2,prng=new t(1019),data=[],worldWidth=10240,worldHeight=10240,deadzoneX=100,deadzoneY=100,player.x=400,player.y=400,viewX=player.x-320,viewY=player.y-180,viewW=640,viewH=360,obstacleCount=1e3,bg=s(worldWidth,worldHeight),spriteSheet=s(1e3,1e3),obstacles=[],createObstacles(),c.width=640,c.height=360,c.style="width: 1280px; height: 720px",gamectx=c.getContext("2d"),function(){bg.ctx.fillStyle="#181",bg.ctx.fillRect(0,0,worldWidth,worldHeight),actx=bg.ctx;for(let e=0;8e4>e;e++)r(prng.nextBoundedInt(0,worldWidth),prng.nextBoundedInt(0,worldHeight),40,20,"rgba(10,50,0,0.05)")}(),drawSprites(),actx=spriteSheet.ctx,actx.translate(sprites.player.x,sprites.player.y),r(50,50,40,40,"white"),actx.restore,actx=spriteSheet.ctx,actx.save(),actx.translate(sprites.obstacle.x,sprites.obstacle.y),o(20,20,60,60,"#400"),actx.restore(),music=new n,music.init(a),done=!1,soundsReady=0,sndData=[{name:"song",data:a},{name:"cellComplete",data:i}],sndData.forEach(function(e){var t=new n;t.init(e.data);var a=!1;setInterval(function(){if(!a&&(a=1==t.generate())){let n=t.createWave().buffer;audioCtx.decodeAudioData(n,function(t){sounds[e.name]=t,soundsReady++})}},0)}),paused=!1,loop()}),window.addEventListener("keyup",function(e){Key.onKeyup(e)},!1),window.addEventListener("keydown",function(e){Key.onKeydown(e)},!1),window.addEventListener("blur",function(e){paused=!0},!1),window.addEventListener("focus",function(e){paused=!1},!1),loop=(()=>{for(now=timeStamp(),dt+=Math.min(1,(now-last)/1e3),elapsed=now-start;dt>tick;)dt-=tick,states[state].step(tick);states[state].draw(dt),requestAnimationFrame(loop)}),createObstacles=(()=>{for(let e=0;e<obstacleCount;e++)obstacles.push({type:"obstacle",x:prng.nextBoundedInt(0,worldWidth),y:prng.nextBoundedInt(0,worldHeight),width:40,height:40})}),drawObstacles=(()=>{obstacles.forEach(function(e,t,n){var a,i,o;(function(e,t,n=64){return!(0-n>e||e>viewW+n||0-n>t||t>viewH+n)})(e.x-viewX,e.y-viewH)&&(a=sprites.obstacle,i=e.x-viewX,o=e.y-viewY,actx.drawImage(spriteSheet.c,a.x,a.y,a.width,a.height,i,o,a.width,a.height))})}),sprites={player:{x:0,y:0,width:100,height:100},obstacle:{x:100,y:0,width:80,height:80}},drawSprites=(()=>{}),states.play={draw:function(e){actx=gamectx,o(0,0,c.width,c.height,"red"),actx.drawImage(bg.c,viewX,viewY,640,360,0,0,640,360),player.draw(e),drawObstacles()},step:function(t){Key.justReleased(Key.r)&&(e(sounds.cellComplete,1,0,.5,!1),Key.update()),player.update(),player.x-viewX+deadzoneX>viewW?viewX=player.x-(viewW-deadzoneX):player.x-deadzoneX<viewX&&(viewX=player.x-deadzoneX),player.y-viewY+deadzoneY>viewH?viewY=player.y-(viewH-deadzoneY):player.y-deadzoneY<viewY&&(viewY=player.y-deadzoneY)}},states.title={init:function(){gameSong=e(sounds.song,1,0,.5,!0)},draw:function(e){actx=gamectx,o(0,0,c.width,c.height,"yellow"),actx.fillStyle="#000",actx.font="30px monospace",actx.textAlign="center",actx.fillText("BACKUP",c.width/2,c.height/2),actx.font="30px monospace",actx.textAlign="center",actx.fillText("Press SPACE to play",c.width/2,c.height/2+40)},step:function(t){Key.justReleased(Key.SPACE)&&(e(sounds.cellComplete,1,0,.5,!1),state="play",Key.update())}},states.loading={draw:function(e){actx=gamectx,o(0,0,c.width,c.height,"black"),actx.fillStyle="#0f0",actx.font="30px monospace",actx.textAlign="center",actx.fillText(loadingText[(soundsReady==totalSounds)+0],c.width/2,c.height/2),actx.font="10px monospace",actx.textAlign="center",actx.fillText(loadingText[paused+2],c.width/2,c.height/2+40)},step:function(t){actx=gamectx,paused||Key.justReleased(Key.p)&&(e(sounds.cellComplete,1,0,.5,!1),state="title",Key.update())}},window.init()}();